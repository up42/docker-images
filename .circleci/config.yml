version: 2.1
orbs:
  anchore: anchore/anchore-engine@1.6.6

jobs:
   build:
    docker:
      - image: circleci/python:3.8
    environment:
      ANCHORE_VERSION: v0.6.1
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker image
          command: make build all
      - anchore/analyze_local_image:
          dockerfile_path: ./dockerfiles/blocks/py38/Dockerfile_tf2_py38
          image_name: 'up42-tf2-py38:latest'
          policy_failure: false
          timeout: '1000'
      - anchore/analyze_local_image:
          dockerfile_path: ./dockerfiles/blocks/py38/Dockerfile_gdal_py38
          image_name: 'up42-gdal-py38:latest'
          policy_failure: false
          timeout: '600'
      - anchore/analyze_local_image:
          dockerfile_path: ./dockerfiles/blocks/py38/Dockerfile_harp_py38
          image_name: 'up42-harp-py38:latest'
          policy_failure: false
          timeout: '600'
      - anchore/analyze_local_image:
          dockerfile_path: ./dockerfiles/blocks/py38/Dockerfile_base_py38
          image_name: 'up42-base-py38:latest'
          policy_failure: false
          timeout: '600'
      - anchore/analyze_local_image:
          dockerfile_path: ./dockerfiles/blocks/py38/Dockerfile_blockutils_py38
          image_name: 'up42-blockutils-py38:latest'
          policy_failure: false
          timeout: '600'
      - anchore/analyze_local_image:
          dockerfile_path: ./dockerfiles/blocks/py38/Dockerfile_snap_py38
          image_name: 'up42-snap-py38:latest'
          policy_failure: false
          timeout: '600'
      - anchore/analyze_local_image:
          dockerfile_path: ./dockerfiles/blocks/py37/Dockerfile_tf1_py37
          image_name: 'up42-tf1-py37:latest'
          policy_failure: false
          timeout: '600'
      - anchore/parse_reports
      - store_artifacts:
          path: anchore-reports
   push:
     docker:
       - image: circleci/python:3.8
     steps:
       - checkout
       - setup_remote_docker
       - run:
           name: Build Docker image
           command: make build all
           no_output_timeout: 30m
       - run:
           name: Push Docker image
           command: make push all
           no_output_timeout: 30m

workflows:
  version: 2
  build-master:
    jobs:
      - build:
         filters:
           branches:
             ignore: master
      - push:
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-tf2-py38:latest'
          timeout: '1000'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-gdal-py38:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-harp-py38:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-base-py38:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
        image_name: 'docker.io/up42/up42-blockutils-py38:latest'
        timeout: '600'
        requires:
          - push
        filters:
          branches:
            only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-snap-py38:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-tf1-py37:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
