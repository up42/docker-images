version: 2.1
orbs:
  anchore: anchore/anchore-engine@1.6.6

jobs:
   build:
     docker:
       - image: circleci/python:3.7
     steps:
       - checkout
       - setup_remote_docker
       - run:
           name: Build Docker image
           command: make build all
   push:
     docker:
       - image: circleci/python:3.7
     steps:
       - checkout
       - setup_remote_docker
       - run:
           name: Build Docker image
           command: make build all
       - run:
           name: Push Docker image
           command: make push all

workflows:
  version: 2
  build-master:
    jobs:
      - build
      - push:
          requires:
            - build
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-tf2-py37:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-gdal-py37:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-harp-py37:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-base-py37:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-snap-py37:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
      - anchore/image_scan:
          image_name: 'docker.io/up42/up42-tf1-py37:latest'
          timeout: '600'
          requires:
            - push
          filters:
            branches:
              only: master
